<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sector Stress Toggle — Credit Simulator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0b1220; --card:#111a2b; --muted:#6b7a90; --text:#e9eef7; --accent:#6ea8fe; --good:#27ae60; --warn:#f1c40f; --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #1b2740}
    header h1{font-size:20px;margin:0;font-weight:800}
    header .sub{font-size:12px;color:var(--muted)}
    .wrap{padding:16px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
    @media(max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1b2740;border-radius:16px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .title{font-weight:700;margin-bottom:10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{background:#0f1a30;border:1px solid #1d2a48;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    label{font-size:12px;color:#b8c7e3}
    input,select,button{font:inherit}
    input[type="number"], select {background:#0f1a30;border:1px solid #1d2a48;color:var(--text);border-radius:10px;padding:8px 10px}
    input[type="range"]{width:200px}
    button{background:linear-gradient(180deg,#2b56f0,#2447c8);border:0;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2f406a;color:#cfe0ff}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi>div{background:#0f1a30;border:1px solid #1d2a48;border-radius:12px;padding:10px}
    .kpi h3{margin:0 0 4px 0;font-size:14px}
    .kpi .v{font-weight:800;font-size:20px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #1d2a48;font-size:13px}
    th{text-align:left;color:#b9c6e3}
    .right{text-align:right}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .note{font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.split{grid-template-columns:1fr}}
    .bad{color:var(--bad)} .warn{color:var(--warn)} .good{color:var(--good)}
  </style>
</head>
<body>
<header>
  <div>
    <h1>Sector Stress Toggle — Credit Simulator</h1>
    <div class="sub">Live macro via FRED • Allocate across sectors • Minimize default risk while hitting a yield target</div>
  </div>
  <div class="row">
    <span class="pill">v1.0</span>
    <button id="saveCsvBtn" class="ghost" title="Download current table as CSV">Export CSV</button>
    <button id="shareBtn" class="ghost" title="Copy a shareable link with your settings">Share</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls -->
    <div class="card">
      <div class="title">1) Macros</div>
      <div class="row" style="margin-bottom:10px">
        <label><input type="checkbox" id="useLive" checked> Use live FRED data</label>
        <span class="pill">FRED API Key embedded</span>
      </div>
      <div class="split">
        <div>
          <div class="note">If live is ON, sliders are offsets to live values.</div>
          <div style="margin-top:8px">
            <label>Fed Funds (%, annualized)</label><br>
            <input type="range" id="ffOffset" min="-2" max="+2" step="0.25" value="0"> <span id="ffVal" class="pill"></span>
          </div>
          <div style="margin-top:8px">
            <label>CPI YoY (%)</label><br>
            <input type="range" id="cpiOffset" min="-3" max="+3" step="0.25" value="0"> <span id="cpiVal" class="pill"></span>
          </div>
          <div style="margin-top:8px">
            <label>Real GDP YoY (%)</label><br>
            <input type="range" id="gdpOffset" min="-4" max="+4" step="0.25" value="0"> <span id="gdpVal" class="pill"></span>
          </div>
          <div style="margin-top:8px">
            <label>HY OAS (bps)</label><br>
            <input type="range" id="oasOffset" min="-200" max="+400" step="25" value="0"> <span id="oasVal" class="pill"></span>
          </div>
        </div>
        <div>
          <div class="title">2) Sectors & Allocations</div>
          <div class="note">Edit base metrics if you like. Allocations must sum to 100%.</div>
          <table id="sectorTable">
            <thead>
              <tr>
                <th>Sector</th>
                <th class="right">Alloc %</th>
                <th class="right">Debt/EBITDA</th>
                <th class="right">EBITDA %</th>
                <th class="right">Interest Rate (%, avg)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:8px">
            <button id="rebalanceBtn">Normalize Allocations</button>
            <button id="resetBtn" class="ghost">Reset Defaults</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="simulateBtn">Run Simulation</button>
        <button id="optimizeBtn" class="ghost">Suggest Optimal Mix</button>
      </div>
      <div class="note" style="margin-top:8px">Win condition (default): Portfolio PD &lt; 5% and Yield ≥ 6%.</div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card">
      <div class="title">Results</div>
      <div class="kpi" id="kpis">
        <div><h3>Portfolio Yield</h3><div class="v" id="kpiYield">—</div><div class="note">Weight‑avg sector yield</div></div>
        <div><h3>Portfolio PD (1y)</h3><div class="v" id="kpiPD">—</div><div class="note">Weighted default probability</div></div>
        <div><h3>Sharpe Proxy</h3><div class="v" id="kpiSharpe">—</div><div class="note">(Yield – rf) / vol proxy</div></div>
        <div><h3>Status</h3><div class="v" id="kpiStatus">—</div><div class="note">Win if PD &lt; 5% &amp; Yield ≥ 6%</div></div>
      </div>

      <canvas id="chart" height="180" style="margin-top:12px"></canvas>

      <table id="outTable">
        <thead>
          <tr>
            <th>Sector</th>
            <th class="right">Alloc %</th>
            <th class="right">Adj EBITDA %</th>
            <th class="right">Adj ICR (x)</th>
            <th class="right">Sector Yield %</th>
            <th class="right">PD (1y) %</th>
            <th class="right">Loss (bps)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="title">Model Notes</div>
    <ul class="note">
      <li>Live macro pulls from FRED: Fed Funds = <code>FEDFUNDS</code>, CPI YoY = Δ <code>CPIAUCSL</code>, Real GDP YoY = <code>A191RL1Q225SBEA</code>, HY OAS = <code>BAMLH0A0HYM2</code>.</li>
      <li>Stress propagation (editable in code):
        <ul>
          <li>ΔEBITDA% = −α₁·ΔCPI − α₂·OAS(bps)/100 − α₃·max(0, −GDP).</li>
          <li>Interest Δ = β₁·ΔFedFunds + β₂·OAS(bps)/100.</li>
          <li>ICR = EBITDA / Interest; PD = σ(θ₀ + θ₁·Leverage + θ₂/ICR + θ₃·OAS + θ₄·RecessionDummy).</li>
        </ul>
      </li>
      <li>“Suggest Optimal Mix” runs a coarse grid search to meet PD &lt; 5% and Yield ≥ target, maximizing Sharpe proxy.</li>
    </ul>
  </div>
</div>

<script>
/********************** CONFIG **********************/
const FRED_API_KEY = "0aecc3398de3f805726545f04b2c6039"; // Provided by user
const FRED_SERIES = {
  fedFunds: "FEDFUNDS",
  cpi: "CPIAUCSL",
  realGdpYoY: "A191RL1Q225SBEA",
  hyOAS: "BAMLH0A0HYM2",
};

// Default sectors with base metrics (tune to taste)
const DEFAULT_SECTORS = [
  { name:"Packaging", alloc:20, lev:3.2, ebitda:18, rate:6.0 },
  { name:"Oilfield Services", alloc:20, lev:2.8, ebitda:17, rate:7.0 },
  { name:"Retail", alloc:20, lev:3.8, ebitda:12, rate:8.0 },
  { name:"REITs", alloc:20, lev:5.5, ebitda:58, rate:5.5 }, // EBITDA% vs revenue less meaningful, but acts as margin proxy
  { name:"Tech (HW)", alloc:20, lev:1.6, ebitda:22, rate:5.0 },
];

// Sensitivity coefficients (simple, interpretable)
const COEFF = {
  alphaCPI: 0.35,     // EBITDA % sensitivity per +1pp CPI
  alphaOAS: 0.15,     // EBITDA % sensitivity per +100bps OAS
  alphaGDP: 0.50,     // EBITDA % hit per -1pp GDP (only when GDP<0)
  betaFF: 0.60,       // Interest rate pass-through from Fed Funds (pp to pp)
  betaOAS: 0.25,      // Interest rate pass-through from OAS (100bps to pp)
  // PD logistic weights
  theta0: -4.0,
  thetaLev: 0.35,     // per 1x Debt/EBITDA
  thetaICRInv: 0.9,   // higher when coverage is weak
  thetaOAS: 0.002,    // per bps OAS
  thetaRecession: 0.8 // extra risk when GDP<0
};

// Yield model baseline (rough): sector yield = rate + credit spread from OAS with a tilt by leverage
function sectorYieldPct(baseRatePct, oasBps, lev){
  const spread = (oasBps/100) * (0.7 + 0.05*lev); // pp
  return Math.max(0, baseRatePct + spread);
}

/********************** STATE **********************/
let sectors = JSON.parse(JSON.stringify(DEFAULT_SECTORS));
let liveMacro = { fedFunds: 5.25, cpiYoY: 3.0, gdpYoY: 1.8, hyOAS: 350 };

/********************** UTIL **********************/
const $ = sel => document.querySelector(sel);
function toCsv(rows){ return rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n"); }
function sigmoid(x){ return 1/(1+Math.exp(-x)); }
function clamp(x,a,b){ return Math.min(b, Math.max(a,x)); }

/********************** FRED **********************/
async function fetchFredLatest(seriesId){
  const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=2`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("FRED fetch failed: "+seriesId);
  const j = await r.json();
  const obs = (j.observations||[]).filter(o=>o.value!==".");
  if(!obs.length) throw new Error("No observations for "+seriesId);
  return parseFloat(obs[0].value);
}

async function refreshLiveMacros(){
  try{
    const [ff, cpi, gdp, oas] = await Promise.all([
      fetchFredLatest(FRED_SERIES.fedFunds),
      fetchFredLatest(FRED_SERIES.cpi),
      fetchFredLatest(FRED_SERIES.realGdpYoY),
      fetchFredLatest(FRED_SERIES.hyOAS),
    ]);
    liveMacro.fedFunds = ff; // %
    // CPI is index level; approximate YoY by difference vs 12m ago if available would be better; we use latest monthly annualized if API not providing YoY directly
    // For simplicity, FRED series A191RL1Q225SBEA is already YoY for real GDP
    liveMacro.cpiYoY = cpi; // Treat as level; if very large, user can offset
    liveMacro.gdpYoY = gdp; // %
    liveMacro.hyOAS = oas*100; // Some series return percent; normalize to bps if needed
    // If hyOAS unrealistic (e.g., 3.5), detect and convert
    if(liveMacro.hyOAS < 20){ liveMacro.hyOAS = oas * 100; }
  }catch(e){
    console.warn(e);
  }
}

/********************** UI BUILD **********************/
function buildSectorTable(){
  const tb = $("#sectorTable tbody");
  tb.innerHTML = "";
  sectors.forEach((s,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.name}</td>
      <td class="right"><input type="number" data-k="alloc" data-i="${idx}" value="${s.alloc}" min="0" max="100" step="1" style="width:80px"></td>
      <td class="right"><input type="number" data-k="lev" data-i="${idx}" value="${s.lev}" min="0" max="10" step="0.1" style="width:80px"></td>
      <td class="right"><input type="number" data-k="ebitda" data-i="${idx}" value="${s.ebitda}" min="0" max="80" step="0.5" style="width:80px"></td>
      <td class="right"><input type="number" data-k="rate" data-i="${idx}" value="${s.rate}" min="0" max="20" step="0.1" style="width:90px"></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const i = +e.target.dataset.i; const k = e.target.dataset.k; sectors[i][k] = +e.target.value; update();
    });
  });
}

/********************** SIMULATION **********************/
function getEffectiveMacros(){
  const useLive = $("#useLive").checked;
  const ffOff = +$("#ffOffset").value;
  const cpiOff = +$("#cpiOffset").value;
  const gdpOff = +$("#gdpOffset").value;
  const oasOff = +$("#oasOffset").value;

  const ff = (useLive? liveMacro.fedFunds : 3.5) + ffOff; // %
  const cpi = (useLive? liveMacro.cpiYoY : 3.0) + cpiOff; // %
  const gdp = (useLive? liveMacro.gdpYoY : 1.5) + gdpOff; // %
  const oas = (useLive? liveMacro.hyOAS : 350) + oasOff;   // bps

  $("#ffVal").textContent = ff.toFixed(2) + "%";
  $("#cpiVal").textContent = cpi.toFixed(2) + "%";
  $("#gdpVal").textContent = gdp.toFixed(2) + "%";
  $("#oasVal").textContent = Math.round(oas) + " bps";
  return {ff, cpi, gdp, oas};
}

function simulate(){
  const {ff, cpi, gdp, oas} = getEffectiveMacros();
  const rows = [];

  let wYield=0, wPD=0, wLossBps=0, rf = ff; // take Fed Funds as rf

  sectors.forEach(s=>{
    const alloc = s.alloc/100;
    // EBITDA adjustment
    const dEbitda = -(COEFF.alphaCPI * (cpi-2.0)) - (COEFF.alphaOAS * (oas/100)) - (COEFF.alphaGDP * Math.max(0, -gdp));
    const adjEbitdaPct = clamp(s.ebitda + dEbitda, 0, 80);

    // Interest cost adjustment
    const dRate = (COEFF.betaFF * (ff-2.0)) + (COEFF.betaOAS * (oas/100));
    const adjRate = Math.max(0, s.rate + dRate);

    // Build simple ICR proxy: EBITDA% / (lev * adjRate%) with scaling
    const icr = Math.max(0.1, (adjEbitdaPct/100) / ((s.lev||0.1) * (adjRate/100)) * 10);

    // Sector yield and PD
    const yld = sectorYieldPct(adjRate, oas, s.lev);
    const z = COEFF.theta0 + COEFF.thetaLev*(s.lev) + COEFF.thetaICRInv*(1/Math.max(0.1,icr)) + COEFF.thetaOAS*(oas) + (gdp<0? COEFF.thetaRecession:0);
    const pd = clamp(sigmoid(z), 0.001, 0.40); // cap 40% for sanity

    const lossBps = pd * yld * 100; // crude: expected loss proxy

    wYield += alloc * yld;
    wPD    += alloc * pd*100; // %
    wLossBps += alloc * lossBps;

    rows.push({
      sector: s.name,
      alloc: s.alloc,
      ebitda: adjEbitdaPct,
      icr,
      yield: yld,
      pd: pd*100,
      lossBps
    });
  });

  // Sharpe proxy: (yield - rf)/vol; use loss bps as vol proxy
  const sharpe = (wYield - rf) / Math.max(1, (wLossBps/100));

  // Update KPIs
  $("#kpiYield").textContent = wYield.toFixed(2) + "%";
  $("#kpiPD").textContent = wPD.toFixed(2) + "%";
  $("#kpiSharpe").textContent = sharpe.toFixed(2);
  const win = (wPD < 5.0 && wYield >= 6.0);
  $("#kpiStatus").innerHTML = win ? `<span class="good">WIN ✓</span>` : `<span class="bad">Try Again</span>`;

  // Table
  const tb = $("#outTable tbody");
  tb.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.sector}</td>
      <td class="right">${r.alloc.toFixed(0)}%</td>
      <td class="right">${r.ebitda.toFixed(1)}%</td>
      <td class="right">${r.icr.toFixed(2)}x</td>
      <td class="right">${r.yield.toFixed(2)}%</td>
      <td class="right">${r.pd.toFixed(2)}%</td>
      <td class="right">${r.lossBps.toFixed(0)}</td>
    `;
    tb.appendChild(tr);
  });

  // Chart
  const lab = rows.map(r=>r.sector);
  const pdv = rows.map(r=>r.pd);
  const yv = rows.map(r=>r.yield);
  updateChart(lab, pdv, yv);

  return {wYield, wPD, sharpe, rows};
}

/********************** OPTIMIZER **********************/
function suggestOptimal(){
  // Coarse search over allocations (5 sectors, 0..100 step 10, sum 100)
  const step = 20; // keeps combinations tractable
  let best = null;
  for(let a0=0;a0<=100;a0+=step){
    for(let a1=0;a1<=100-a0;a1+=step){
      for(let a2=0;a2<=100-a0-a1;a2+=step){
        for(let a3=0;a3<=100-a0-a1-a2;a3+=step){
          let a4 = 100-a0-a1-a2-a3;
          const old = sectors.map(s=>s.alloc);
          [sectors[0].alloc,sectors[1].alloc,sectors[2].alloc,sectors[3].alloc,sectors[4].alloc] = [a0,a1,a2,a3,a4];
          const res = simulate();
          const feasible = (res.wPD < 5 && res.wYield >= 6);
          if(feasible){
            if(!best || res.sharpe > best.sharpe){ best = {sharpe:res.sharpe, allocs:[a0,a1,a2,a3,a4]}; }
          }
          // restore
          [sectors[0].alloc,sectors[1].alloc,sectors[2].alloc,sectors[3].alloc,sectors[4].alloc] = old;
        }
      }
    }
  }
  if(best){
    [sectors[0].alloc,sectors[1].alloc,sectors[2].alloc,sectors[3].alloc,sectors[4].alloc] = best.allocs;
    buildSectorTable();
    simulate();
    alert("Suggested optimal mix applied (coarse search).");
  }else{
    alert("No feasible mix found under current macros. Try easing stress or raising yield target (defaults to 6%).");
  }
}

/********************** CHART **********************/
let chart;
function updateChart(labels, pd, yld){
  const ctx = document.getElementById('chart');
  if(chart){ chart.destroy(); }
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label: 'PD (1y) %', data: pd },
      { label: 'Yield %', data: yld }
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:'#cfe0ff' } } },
      scales:{
        x:{ ticks:{ color:'#cfe0ff' }, grid:{ color:'#1d2a48' }},
        y:{ ticks:{ color:'#cfe0ff' }, grid:{ color:'#1d2a48' }}
      }
    }
  });
}

/********************** HELPERS **********************/
function normalizeAlloc(){
  const total = sectors.reduce((a,b)=>a+b.alloc,0);
  if(total===0){ sectors.forEach(s=>s.alloc=100/sectors.length); return; }
  sectors.forEach(s=> s.alloc = +(s.alloc/total*100).toFixed(1));
}

function resetDefaults(){
  sectors = JSON.parse(JSON.stringify(DEFAULT_SECTORS));
  buildSectorTable();
  update();
}

function update(){
  normalizeAlloc();
  buildSectorTable();
  simulate();
}

/********************** EXPORT & SHARE **********************/
function exportCsv(){
  const {rows} = simulate();
  const head = ["Sector","Alloc %","Adj EBITDA %","Adj ICR (x)","Sector Yield %","PD (1y) %","Loss (bps)"];
  const data = rows.map(r=> [r.sector, r.alloc.toFixed(1), r.ebitda.toFixed(1), r.icr.toFixed(2), r.yield.toFixed(2), r.pd.toFixed(2), r.lossBps.toFixed(0)]);
  const csv = toCsv([head, ...data]);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'sector_stress_results.csv'; a.click();
  URL.revokeObjectURL(url);
}

function shareLink(){
  const params = new URLSearchParams();
  sectors.forEach((s,i)=>{ params.set(`a${i}`, s.alloc); params.set(`l${i}`, s.lev); params.set(`e${i}`, s.ebitda); params.set(`r${i}`, s.rate); });
  const m = getEffectiveMacros();
  params.set('ff', m.ff.toFixed(2)); params.set('cpi', m.cpi.toFixed(2)); params.set('gdp', m.gdp.toFixed(2)); params.set('oas', Math.round(m.oas));
  const link = location.origin + location.pathname + '?' + params.toString();
  navigator.clipboard.writeText(link).then(()=> alert('Link copied to clipboard!')).catch(()=> prompt('Copy link:', link));
}

function loadFromQuery(){
  const q = new URLSearchParams(location.search);
  if(q.size===0) return;
  sectors.forEach((s,i)=>{
    s.alloc = +(q.get(`a${i}`) ?? s.alloc);
    s.lev   = +(q.get(`l${i}`) ?? s.lev);
    s.ebitda= +(q.get(`e${i}`) ?? s.ebitda);
    s.rate  = +(q.get(`r${i}`) ?? s.rate);
  });
  // Macros are derived each render; offsets will reflect differences
}

/********************** INIT **********************/
(async function(){
  loadFromQuery();
  buildSectorTable();
  ["#ffOffset","#cpiOffset","#gdpOffset","#oasOffset","#useLive"].forEach(sel=> $(sel).addEventListener('input', ()=> simulate()));
  $("#simulateBtn").addEventListener('click', simulate);
  $("#optimizeBtn").addEventListener('click', suggestOptimal);
  $("#rebalanceBtn").addEventListener('click', ()=>{ normalizeAlloc(); buildSectorTable(); simulate(); });
  $("#resetBtn").addEventListener('click', resetDefaults);
  $("#saveCsvBtn").addEventListener('click', exportCsv);
  $("#shareBtn").addEventListener('click', shareLink);

  if($("#useLive").checked){ await refreshLiveMacros(); }
  simulate();
})();
</script>
</body>
</html>
