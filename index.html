<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Credit Stress Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <meta name="description" content="Interactive Credit Stress Simulator for teaching / demos. Single-file app for GitHub Pages." />
  <style>
    /* Subtle scrollbars + number input alignment */
    input[type="number"] { text-align: right; }
    .kpi { min-width: 12rem; }
    .heatmap-cell { transition: background-color 0.3s ease; }
    .heatmap-label { font-size: 0.75rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  
<header class="bg-white shadow">
  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold text-gray-900">Credit Stress Simulator</h1>
    <p class="mt-1 text-sm text-gray-500">
      Interactive tool to model the impact of macroeconomic scenarios on a credit portfolio.
    </p>
  </div>
</header>

<main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
  <div class="space-y-6">
    
    <div class="bg-white p-6 shadow-md rounded-lg">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Portfolio & Scenario Controls</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        
        <div>
          <label for="portfolioUpload" class="block text-sm font-medium text-gray-700">Upload Portfolio (JSON)</label>
          <input type="file" id="portfolioUpload" accept=".json" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
          <p id="portfolioStatus" class="mt-1 text-xs text-green-600">Using sample portfolio (5 assets).</p>
        </div>
        
        <div>
          <label for="scenarioPreset" class="block text-sm font-medium text-gray-700">Select Preset</label>
          <select id="scenarioPreset" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
            <option value="none">Custom Scenario</option>
            <option value="rateHike">Fed Rate Hike (+200bps)</option>
            <option value="oilShock">Oil Shock (+30%)</option>
            <option value="downgradeWave">Sector Downgrade Wave</option>
          </select>
        </div>
        
        <div>
          <label for="rateHikeBps" class="block text-sm font-medium text-gray-700">Rate Shock (bps)</label>
          <input type="number" id="rateHikeBps" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-right">
        </div>

        <div>
          <label for="defaultMultiplier" class="block text-sm font-medium text-gray-700">Default Rate Multiplier</label>
          <input type="number" id="defaultMultiplier" step="0.1" value="1.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-right">
        </div>
      </div>

      <button onclick="runSimulation()" class="mt-6 w-full md:w-auto px-6 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        Run Simulation
      </button>
    </div>

    <div class="bg-white p-6 shadow-md rounded-lg">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Executive Summary KPIs</h2>
      <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5">
        
        <div class="kpi bg-slate-50 overflow-hidden rounded-lg shadow-sm px-4 py-5 sm:p-6 border-l-4 border-red-500">
          <dt class="text-sm font-medium text-gray-500 truncate">Portfolio PnL Impact</dt>
          <dd id="kpiPnL" class="mt-1 text-3xl font-semibold text-gray-900">$0.00M</dd>
        </div>

        <div class="kpi bg-slate-50 overflow-hidden rounded-lg shadow-sm px-4 py-5 sm:p-6 border-l-4 border-orange-500">
          <dt class="text-sm font-medium text-gray-500 truncate">Stress VaR (99%)</dt>
          <dd id="kpiVaR" class="mt-1 text-3xl font-semibold text-gray-900">$0.00M</dd>
        </div>

        <div class="kpi bg-slate-50 overflow-hidden rounded-lg shadow-sm px-4 py-5 sm:p-6 border-l-4 border-red-600">
          <dt class="text-sm font-medium text-gray-500 truncate">New Defaults (Count)</dt>
          <dd id="kpiDefaults" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
        
        <div class="kpi bg-slate-50 overflow-hidden rounded-lg shadow-sm px-4 py-5 sm:p-6 border-l-4 border-yellow-500">
          <dt class="text-sm font-medium text-gray-500 truncate">Average Rating Migration</dt>
          <dd id="kpiRatingMigration" class="mt-1 text-3xl font-semibold text-gray-900">0.0 Notches</dd>
        </div>

        <div class="kpi bg-slate-50 overflow-hidden rounded-lg shadow-sm px-4 py-5 sm:p-6 border-l-4 border-green-500">
          <dt class="text-sm font-medium text-gray-500 truncate">Covenant Breaches</dt>
          <dd id="kpiCovenantBreaches" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 bg-white p-6 shadow-md rounded-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">PnL Driver Attribution ($M)</h2>
            <div id="pnlAttribution" class="space-y-3">
                <div class="flex justify-between border-b pb-1">
                    <span class="text-sm font-medium text-gray-600">Interest Rate Shock:</span>
                    <span id="attrRate" class="text-sm font-semibold text-gray-900">0.00</span>
                </div>
                <div class="flex justify-between border-b pb-1">
                    <span class="text-sm font-medium text-gray-600">Spread Widening:</span>
                    <span id="attrSpread" class="text-sm font-semibold text-gray-900">0.00</span>
                </div>
                <div class="flex justify-between border-b pb-1">
                    <span class="text-sm font-medium text-gray-600">Default Losses:</span>
                    <span id="attrDefault" class="text-sm font-semibold text-red-600">0.00</span>
                </div>
                <div class="flex justify-between pt-2 border-t font-bold">
                    <span>Total PnL Impact:</span>
                    <span id="attrTotal" class="text-gray-900">0.00</span>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white p-6 shadow-md rounded-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Watchlist (At-Risk Names & Covenant Breaches)</h2>
            <ul id="watchlist" class="divide-y divide-gray-200 h-60 overflow-y-auto">
                <li class="py-2 text-sm text-gray-500 italic">Run simulation to populate watchlist...</li>
            </ul>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <div class="lg:col-span-1 bg-white p-6 shadow-md rounded-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Sector-Rating Heatmap (Notional $M)</h2>
        <div id="heatmapContainer" class="p-2 border border-gray-200">
            <div id="heatmap" class="grid grid-cols-6 gap-0.5">
                <div class="heatmap-label font-bold text-gray-500 p-1">Sector</div>
                <div class="heatmap-label font-bold text-gray-500 text-center p-1">AAA-A</div>
                <div class="heatmap-label font-bold text-gray-500 text-center p-1">BBB</div>
                <div class="heatmap-label font-bold text-gray-500 text-center p-1">BB</div>
                <div class="heatmap-label font-bold text-gray-500 text-center p-1">B-CCC</div>
                <div class="heatmap-label font-bold text-gray-500 text-center p-1">D</div>
                </div>
        </div>
      </div>

      <div class="lg:col-span-2 bg-white p-6 shadow-md rounded-lg">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Portfolio Value Over Time</h2>
        <canvas id="pnlChart" class="h-80"></canvas>
      </div>
    </div>

  </div>
</main>

<script>
  // --- 1. CORE DATA & CONSTANTS ---
  let currentPortfolio = [];
  const initialSamplePortfolio = [
    { name: "Global Auto Co.", sector: "Automotive", rating: "BBB", duration: 5, notional: 500, PD: 0.005, recovery: 0.40, spread: 250, leverage: 3.5, maxLeverage: 4.0, industry: 'Cyclical' },
    { name: "Tech Services Inc.", sector: "Technology", rating: "A", duration: 3, notional: 800, PD: 0.002, recovery: 0.50, spread: 150, leverage: 2.1, maxLeverage: 3.0, industry: 'Stable' },
    { name: "Regional Bank PLC", sector: "Financials", rating: "BB", duration: 6, notional: 300, PD: 0.015, recovery: 0.35, spread: 400, leverage: 4.8, maxLeverage: 5.0, industry: 'Cyclical' },
    { name: "Energy Explorer LLC", sector: "Energy", rating: "B", duration: 7, notional: 200, PD: 0.030, recovery: 0.30, spread: 650, leverage: 5.5, maxLeverage: 6.0, industry: 'Cyclical' },
    { name: "Consumer Goods Group", sector: "Consumer", rating: "AAA", duration: 4, notional: 700, PD: 0.001, recovery: 0.55, spread: 100, leverage: 1.5, maxLeverage: 3.5, industry: 'Stable' },
  ];

  // Helper functions for rating conversion
  const ratingToScore = { "AAA": 7, "AA": 6, "A": 5, "BBB": 4, "BB": 3, "B": 2, "CCC": 1, "D": 0 };
  const scoreToRating = { 7: "AAA", 6: "AA", 5: "A", 4: "BBB", 3: "BB", 2: "B", 1: "CCC", 0: "D" };
  const ratingToGroup = (rating) => {
    const score = ratingToScore[rating];
    if (score >= 5) return 'AAA-A';
    if (score === 4) return 'BBB';
    if (score === 3) return 'BB';
    if (score >= 1) return 'B-CCC';
    return 'D';
  };
  const ratingGroups = ['AAA-A', 'BBB', 'BB', 'B-CCC', 'D'];

  // Scenario Presets: Added stress-related impacts
  const scenarioPresets = {
    'rateHike': { rateHikeBps: 200, defaultMultiplier: 1.5, ratingShift: -1, sectorImpact: { 'Financials': -2, 'Consumer': -1 }, leverageIncrease: 0.5 },
    'oilShock': { rateHikeBps: 50, defaultMultiplier: 2.5, ratingShift: 0, sectorImpact: { 'Energy': -3, 'Automotive': -2 }, leverageIncrease: 0.3 },
    'downgradeWave': { rateHikeBps: 0, defaultMultiplier: 1.8, ratingShift: -1, sectorImpact: { 'Financials': -1, 'Technology': -1 }, leverageIncrease: 0.4 }
  };

  // --- 2. FILE UPLOAD HANDLER ---
  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (Array.isArray(data) && data.length > 0) {
          // Validate structure (simplified check)
          if (data[0].name && data[0].notional && data[0].rating) {
            currentPortfolio = data;
            document.getElementById('portfolioStatus').innerText = `Portfolio loaded successfully (${data.length} assets).`;
            document.getElementById('portfolioStatus').classList.replace('text-red-600', 'text-green-600');
            runSimulation();
          } else {
            throw new Error("Invalid portfolio structure. Requires 'name', 'notional', 'rating', etc.");
          }
        } else {
          throw new Error("The file is empty or not a valid array.");
        }
      } catch (error) {
        console.error("Error parsing file:", error);
        currentPortfolio = initialSamplePortfolio; // Fallback
        document.getElementById('portfolioStatus').innerText = `Error loading portfolio: ${error.message}. Using sample data.`;
        document.getElementById('portfolioStatus').classList.replace('text-green-600', 'text-red-600');
      }
    };
    reader.readAsText(file);
  }

  // --- 3. SIMULATION LOGIC ---
  function runSimulation() {
    // Ensure we have a portfolio loaded
    if (currentPortfolio.length === 0) {
        currentPortfolio = initialSamplePortfolio;
    }
    
    const preset = document.getElementById('scenarioPreset').value;
    let rateHikeBps = parseFloat(document.getElementById('rateHikeBps').value);
    let defaultMultiplier = parseFloat(document.getElementById('defaultMultiplier').value);
    
    let baseRatingShift = 0;
    let sectorRatingImpact = {};
    let leverageIncrease = 0;

    // Apply preset values if selected
    if (preset !== 'none' && scenarioPresets[preset]) {
      const p = scenarioPresets[preset];
      rateHikeBps = p.rateHikeBps;
      defaultMultiplier = p.defaultMultiplier;
      baseRatingShift = p.ratingShift;
      sectorRatingImpact = p.sectorImpact;
      leverageIncrease = p.leverageIncrease;
    }

    const marketRateDelta = rateHikeBps / 10000;
    
    let totalPnLImpact = 0;
    let totalRatePnL = 0;
    let totalSpreadPnL = 0;
    let totalDefaultLoss = 0;
    let newDefaults = 0;
    let totalNotchShift = 0;
    let covenantBreaches = 0;
    let watchlistNames = [];
    const heatmapData = {};
    const sectors = [...new Set(currentPortfolio.map(a => a.sector))];
    sectors.forEach(s => heatmapData[s] = {});
    ratingGroups.forEach(g => sectors.forEach(s => heatmapData[s][g] = 0));


    const stressedPortfolio = currentPortfolio.map(asset => {
      // 1. Rating Migration & Spread Impact
      const sectorShift = sectorRatingImpact[asset.sector] || 0;
      // Rating cannot go below D (score 0)
      const totalShiftScore = Math.max(0, ratingToScore[asset.rating] + baseRatingShift + sectorShift); 
      const newRating = scoreToRating[totalShiftScore] || 'D';
      totalNotchShift += (totalShiftScore - ratingToScore[asset.rating]);

      // Simplified Spread Calculation: Spreads widen as ratings drop
      const ratingDrop = ratingToScore[asset.rating] - totalShiftScore;
      const newSpread = asset.spread * (1 + ratingDrop * 0.15); // 15% widening per notch drop
      
      // Bond Price Change (PnL Attribution)
      const duration = asset.duration || 5; // Default to 5 if not provided
      const spreadDelta = (newSpread - asset.spread) / 10000;

      // PnL 1: Rate Shock Component
      const ratePnL = -duration * asset.notional * marketRateDelta;
      
      // PnL 2: Spread Widening Component
      const spreadPnL = -duration * asset.notional * spreadDelta;
      
      // 2. Default & Loss Calculation
      const stressedPD = asset.PD * defaultMultiplier;
      const lossGivenDefault = asset.notional * (1 - asset.recovery);
      const defaultLoss = lossGivenDefault * stressedPD; // Expected Loss

      // PnL 3: Default Loss Component (Expected Loss)
      totalDefaultLoss += defaultLoss;
      
      // Total PnL (Negative number indicates loss)
      const pnl = ratePnL + spreadPnL - defaultLoss; 
      totalPnLImpact += pnl;
      totalRatePnL += ratePnL;
      totalSpreadPnL += spreadPnL;
      
      // Determine Defaults (Heuristic: if stressed PD > 10%)
      const isDefault = stressedPD >= 0.10;
      if (isDefault) {
        newDefaults += 1;
      }
      
      // 3. Covenant Headroom Check (Simplified: Leverage)
      const stressedLeverage = (asset.leverage || 4.0) + leverageIncrease;
      const isBreached = stressedLeverage > (asset.maxLeverage || 5.0);
      if (isBreached) {
          covenantBreaches += 1;
      }

      // 4. Heatmap Data Aggregation (Using new rating)
      const group = ratingToGroup(newRating);
      heatmapData[asset.sector][group] += asset.notional;

      // Watchlist Check: Low rating AND high expected loss OR covenant breach
      if (totalShiftScore <= ratingToScore['BB'] || isBreached) {
        let reason = [];
        if (totalShiftScore <= ratingToScore['BB']) reason.push('Rating D/G');
        if (isBreached) reason.push('Covenant Breach');

        watchlistNames.push({ 
            name: asset.name, 
            rating: newRating, 
            pnl: pnl.toFixed(2), 
            leverage: stressedLeverage.toFixed(2), 
            reason: reason.join(' / ') 
        });
      }

      return { ...asset, newRating, stressedPD, pnl, stressedLeverage, isBreached };
    });

    // --- 4. KPI & DASHBOARD UPDATE ---
    const totalPortfolioNotional = currentPortfolio.reduce((sum, asset) => sum + asset.notional, 0);

    // VaR: Simplified as total default loss + 1.5x interest/spread loss volatility
    const stressVaR = totalDefaultLoss + Math.abs(totalRatePnL + totalSpreadPnL) * 1.5;
    
    document.getElementById('kpiPnL').innerText = `${totalPnLImpact < 0 ? '-' : ''}$${Math.abs(totalPnLImpact).toFixed(2)}M`;
    document.getElementById('kpiVaR').innerText = `$${stressVaR.toFixed(2)}M`;
    document.getElementById('kpiDefaults').innerText = newDefaults;
    document.getElementById('kpiRatingMigration').innerText = `${(-totalNotchShift / currentPortfolio.length).toFixed(1)} Notches`;
    document.getElementById('kpiCovenantBreaches').innerText = covenantBreaches;

    // PnL Attribution Update
    document.getElementById('attrRate').innerText = totalRatePnL.toFixed(2);
    document.getElementById('attrSpread').innerText = totalSpreadPnL.toFixed(2);
    document.getElementById('attrDefault').innerText = `(${totalDefaultLoss.toFixed(2)})`;
    document.getElementById('attrTotal').innerText = totalPnLImpact.toFixed(2);
    
    // Watchlist Update
    updateWatchlist(watchlistNames);

    // Chart Update
    updatePnlChart(totalPortfolioNotional, totalPnLImpact);

    // Heatmap Update
    renderHeatmap(sectors, heatmapData, totalPortfolioNotional);
  }

  // --- 5. VISUALIZATION AND AUXILIARY FUNCTIONS ---

  function updateWatchlist(watchlistNames) {
    const watchlistEl = document.getElementById('watchlist');
    watchlistEl.innerHTML = ''; // Clear previous
    if (watchlistNames.length === 0) {
      watchlistEl.innerHTML = '<li class="py-2 text-sm text-gray-500 italic">No names meet the at-risk criteria.</li>';
    } else {
        watchlistNames.forEach(item => {
            const li = document.createElement('li');
            li.className = 'py-2 flex justify-between items-center';
            const lossColor = parseFloat(item.pnl) < 0 ? 'text-red-600' : 'text-green-600';
            li.innerHTML = `
                <div>
                    <span class="font-medium">${item.name} (${item.rating})</span>
                    <span class="text-xs text-gray-500 ml-2">| ${item.reason}</span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-400 block">Lev: ${item.leverage}</span>
                    <span class="text-sm ${lossColor} block">${item.pnl}M PnL</span>
                </div>
            `;
            watchlistEl.appendChild(li);
        });
    }
  }

  let pnlChartInstance;

  function updatePnlChart(initialValue, pnlImpact) {
    const ctx = document.getElementById('pnlChart').getContext('2d');
    
    const data = {
      labels: ['T-0 (Pre-Stress)', 'T+1 (Immediate Impact)', 'T+2 (Recovery/Prolonged Stress)'],
      datasets: [{
        label: 'Portfolio Value ($M)',
        data: [
          initialValue, 
          initialValue + pnlImpact,
          initialValue + pnlImpact * 0.8 
        ],
        borderColor: 'rgb(79, 70, 229)',
        backgroundColor: 'rgba(79, 70, 229, 0.1)',
        fill: true,
        tension: 0.2
      }]
    };

    if (pnlChartInstance) {
      pnlChartInstance.data = data;
      pnlChartInstance.update();
    } else {
      pnlChartInstance = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Value ($ Millions)' }
            }
          }
        }
      });
    }
  }

  function getHeatmapColor(value, maxNotional) {
    if (value === 0) return 'bg-gray-100';
    const intensity = value / maxNotional;
    if (intensity < 0.1) return 'bg-indigo-100';
    if (intensity < 0.3) return 'bg-indigo-300';
    if (intensity < 0.6) return 'bg-indigo-500 text-white';
    return 'bg-indigo-700 text-white';
  }

  function renderHeatmap(sectors, heatmapData, totalPortfolioNotional) {
    const heatmapEl = document.getElementById('heatmap');
    heatmapEl.innerHTML = `
        <div class="heatmap-label font-bold text-gray-500 p-1">Sector</div>
        ${ratingGroups.map(g => `<div class="heatmap-label font-bold text-gray-500 text-center p-1">${g}</div>`).join('')}
    `; // Re-render headers

    const maxNotional = Math.max(...sectors.flatMap(s => ratingGroups.map(g => heatmapData[s][g])));

    sectors.forEach(sector => {
      // Sector Row Label
      const sectorLabel = document.createElement('div');
      sectorLabel.className = 'heatmap-label p-1 font-semibold';
      sectorLabel.innerText = sector;
      heatmapEl.appendChild(sectorLabel);

      // Data Cells
      ratingGroups.forEach(group => {
        const value = heatmapData[sector][group] || 0;
        const colorClass = getHeatmapColor(value, maxNotional);
        
        const cell = document.createElement('div');
        cell.className = `heatmap-cell p-1 text-center font-bold rounded ${colorClass}`;
        cell.title = `${sector} / ${group}: $${value.toFixed(0)}M`;
        cell.innerText = value > 0 ? value.toFixed(0) : '-';
        heatmapEl.appendChild(cell);
      });
    });
    
    // Set grid columns dynamically
    heatmapEl.style.gridTemplateColumns = `repeat(${ratingGroups.length + 1}, 1fr)`;
  }


  // --- 6. INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', () => {
    currentPortfolio = initialSamplePortfolio; // Load sample data initially
    runSimulation(); // Run with default values on load
    
    // Add event listeners
    document.getElementById('portfolioUpload').addEventListener('change', handleFileUpload);

    const presetSelect = document.getElementById('scenarioPreset');
    presetSelect.addEventListener('change', (event) => {
      const preset = event.target.value;
      if (preset !== 'none' && scenarioPresets[preset]) {
        document.getElementById('rateHikeBps').value = scenarioPresets[preset].rateHikeBps;
        document.getElementById('defaultMultiplier').value = scenarioPresets[preset].defaultMultiplier;
      } else {
        document.getElementById('rateHikeBps').value = 0;
        document.getElementById('defaultMultiplier').value = 1.0;
      }
    });
  });
</script>
</body>
</html>
