import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, BarChart, Bar } from "recharts";
import { motion } from "framer-motion";
import { DollarSign, TrendingUp, Users, Briefcase, Bell } from "lucide-react";
import React from "react";

export default function Dashboard() {
  // --- Config ---
  const DEFAULT_TICKER = "NFLX";
  const CIKS = {
    NFLX: "0001065280",
    AAPL: "0000320193",
    MSFT: "0000789019",
    AMZN: "0001018724",
    GOOGL: "0001652044",
  } as const;

  // Optional: FRED API Key (insert your key to avoid throttling)
  const FRED_API_KEY = "YOUR_FRED_API_KEY"; // get one free at https://fred.stlouisfed.org/

  // --- State ---
  const [ticker, setTicker] = React.useState<string>(DEFAULT_TICKER);
  const [prices, setPrices] = React.useState<{date:string; close:number}[]>([]);
  const [priceMeta, setPriceMeta] = React.useState<any>(null);
  const [secFacts, setSecFacts] = React.useState<any>(null);
  const [fred, setFred] = React.useState<{ t2y?: any[]; t10y?: any[]; hy?: any[]; ig?: any[] }>({});
  const [loading, setLoading] = React.useState(true);
  const [error, setError] = React.useState("");

  // --- Mock data retained for non-company widgets ---
  const marketData = [
    { name: "Jan", rates: 3.8, spreads: 120 },
    { name: "Feb", rates: 4.0, spreads: 140 },
    { name: "Mar", rates: 4.3, spreads: 160 },
  ];

  const pipelineData = [
    { name: "M&A", deals: 12 },
    { name: "ECM", deals: 8 },
    { name: "DCM", deals: 15 },
    { name: "LevFin", deals: 10 },
  ];

  const aiAlerts = [
    { client: "Client X", alert: "Downgrade probability increased by 20% this week" },
    { client: "Client Y", alert: "Maturity wall approaching in 2026, refinancing at +180bps" },
    { client: "Client Z", alert: "Activist investor disclosed 5% stake yesterday" },
  ];

  // --- Helpers ---
  function latestValueByTag(facts: any, tag: string) {
    try {
      const fact = facts?.facts?.["us-gaap"]?.[tag];
      if (!fact) return null;
      const units = Object.values(fact.units || {});
      if (!units.length) return null;
      const all: any[] = (units as any[]).flat().filter((x: any) => x?.val !== null);
      all.sort((a, b) => new Date(b.end).getTime() - new Date(a.end).getTime());
      return all[0] || null;
    } catch (e) {
      return null;
    }
  }

  function fmtUSD(n?: number) {
    if (n == null) return "‚Äî";
    const abs = Math.abs(n);
    const sign = n < 0 ? "-" : "";
    if (abs >= 1e12) return `${sign}${(abs / 1e12).toFixed(2)}T`;
    if (abs >= 1e9) return `${sign}${(abs / 1e9).toFixed(2)}B`;
    if (abs >= 1e6) return `${sign}${(abs / 1e6).toFixed(2)}M`;
    return `${sign}${abs.toLocaleString()}`;
  }

  // --- Effects: Fetch Yahoo Finance prices + SEC facts ---
  React.useEffect(() => {
    async function fetchCompany(tkr: string) {
      setLoading(true);
      setError("");
      try {
        // 1) Yahoo Finance price history
        const yf = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${tkr}?range=6mo&interval=1d`);
        const yfJson = await yf.json();
        const r = yfJson?.chart?.result?.[0];
        if (r) {
          const tzOffset = r.meta.gmtoffset || 0;
          const series = r.timestamp
            .map((t: number, idx: number) => ({
              date: new Date((t + tzOffset) * 1000).toISOString().slice(0, 10),
              close: r.indicators.quote[0].close[idx],
            }))
            .filter((d: any) => d.close != null);
          setPrices(series);
          setPriceMeta(r.meta);
        } else {
          setPrices([]);
          setPriceMeta(null);
        }

        // 2) SEC Company Facts (official)
        const cik = (CIKS as any)[tkr];
        if (!cik) throw new Error(`No CIK mapping for ${tkr}`);
        const sec = await fetch(`https://data.sec.gov/api/xbrl/companyfacts/CIK${cik}.json`, {
          headers: {
            "User-Agent": "IB-Dashboard (your-email@example.com)",
            Accept: "application/json",
          },
        });
        if (!sec.ok) throw new Error(`SEC ${sec.status}`);
        const secJson = await sec.json();
        setSecFacts(secJson);
      } catch (e: any) {
        console.error(e);
        setError("Live data fetch failed (likely CORS or throttling). Using placeholders. See code comments.");
      } finally {
        setLoading(false);
      }
    }

    fetchCompany(ticker);
  }, [ticker]);

  // Fetch FRED macro curves & spreads (UST 2Y/10Y, HY OAS, IG OAS)
  React.useEffect(() => {
    async function fetchFred(series: string) {
      const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${series}&api_key=${FRED_API_KEY}&file_type=json&observation_start=${new Date(new Date().setFullYear(new Date().getFullYear()-1)).toISOString().slice(0,10)}`;
      const res = await fetch(url);
      return res.ok ? res.json() : null;
    }
    async function go() {
      try {
        const [t2y, t10y, hy, ig] = await Promise.all([
          fetchFred("DGS2"), // 2Y UST
          fetchFred("DGS10"), // 10Y UST
          fetchFred("BAMLH0A0HYM2"), // ICE BofA US High Yield OAS
          fetchFred("BAMLC0A0CM"), // ICE BofA US Corporate (IG) OAS
        ]);
        setFred({ t2y: t2y?.observations, t10y: t10y?.observations, hy: hy?.observations, ig: ig?.observations });
      } catch (e) {
        console.warn("FRED fetch failed", e);
      }
    }
    if (FRED_API_KEY && FRED_API_KEY !== "YOUR_FRED_API_KEY") go();
  }, []);

  // --- Derived fundamentals from SEC ---
  const rev = latestValueByTag(secFacts, "Revenues");
  const ni = latestValueByTag(secFacts, "NetIncomeLoss");
  const assets = latestValueByTag(secFacts, "Assets");
  const liab = latestValueByTag(secFacts, "Liabilities");
  const equity = latestValueByTag(secFacts, "StockholdersEquity");

  const lastClose = prices.length ? prices[prices.length - 1].close : null;
  const prevClose = prices.length > 1 ? prices[prices.length - 2].close : null;
  const dayChg = lastClose != null && prevClose != null ? ((lastClose - prevClose) / prevClose) * 100 : null;

  // Convert FRED obs to chart data
  const fredSeries = (obs?: any[]) =>
    (obs || [])
      .filter((o) => o.value !== ".")
      .map((o) => ({ date: o.date, value: Number(o.value) }));

  return (
    <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {/* Controls */}
      <div className="col-span-3 flex items-center gap-3">
        <label className="text-sm text-gray-600">Ticker</label>
        <select
          className="border rounded-xl px-3 py-2 text-sm"
          value={ticker}
          onChange={(e) => setTicker(e.target.value)}
        >
          {Object.keys(CIKS).map((k) => (
            <option key={k} value={k}>
              {k}
            </option>
          ))}
        </select>
        {loading && <span className="text-xs text-gray-500">Loading {ticker}‚Ä¶</span>}
        {error && <span className="text-xs text-yellow-700">{error}</span>}
      </div>

      {/* Company Snapshot */}
      <Card className="col-span-3">
        <CardContent>
          <h2 className="text-xl font-bold mb-2">üè¢ Company Snapshot ‚Äî {ticker}</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="flex flex-col"><span className="text-xs text-gray-500">Last Close</span><span className="text-lg font-semibold">{lastClose ? `$${lastClose.toFixed(2)}` : "‚Äî"}</span></div>
            <div className="flex flex-col"><span className="text-xs text-gray-500">Day Change</span><span className={`text-lg font-semibold ${dayChg! > 0 ? "text-green-600" : dayChg! < 0 ? "text-red-600" : ""}`}>{dayChg != null ? `${dayChg.toFixed(2)}%` : "‚Äî"}</span></div>
            <div className="flex flex-col"><span className="text-xs text-gray-500">Market Cap*</span><span className="text-lg font-semibold">{priceMeta?.marketCap ? fmtUSD(priceMeta.marketCap) : "‚Äî"}</span></div>
            <div className="flex flex-col"><span className="text-xs text-gray-500">Price Currency</span><span className="text-lg font-semibold">{priceMeta?.currency || "‚Äî"}</span></div>
          </div>
          <p className="text-xs text-gray-400 mt-2">*From Yahoo Finance meta when available. Data shown is for {ticker}.</p>
          <div className="mt-4" style={{ width: "100%", height: 240 }}>
            <ResponsiveContainer width="100%" height={240}>
              <LineChart data={prices}>
                <XAxis dataKey="date" tick={{ fontSize: 12 }} />
                <YAxis domain={["auto", "auto"]} tick={{ fontSize: 12 }} />
                <Tooltip />
                <Line type="monotone" dataKey="close" stroke="#111827" name="Close" />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </CardContent>
      </Card>

      {/* SEC Fundamentals */}
      <Card className="col-span-3">
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üèõÔ∏è SEC Fundamentals (Official filings)</h2>
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div className="p-3 rounded-2xl bg-gray-50"><div className="text-xs text-gray-500">Revenue (latest)</div><div className="text-lg font-semibold">{fmtUSD(rev?.val)}</div><div className="text-[10px] text-gray-400">Period end: {rev?.end || "‚Äî"}</div></div>
            <div className="p-3 rounded-2xl bg-gray-50"><div className="text-xs text-gray-500">Net Income (latest)</div><div className="text-lg font-semibold">{fmtUSD(ni?.val)}</div><div className="text-[10px] text-gray-400">Period end: {ni?.end || "‚Äî"}</div></div>
            <div className="p-3 rounded-2xl bg-gray-50"><div className="text-xs text-gray-500">Assets</div><div className="text-lg font-semibold">{fmtUSD(assets?.val)}</div><div className="text-[10px] text-gray-400">{assets?.end || "‚Äî"}</div></div>
            <div className="p-3 rounded-2xl bg-gray-50"><div className="text-xs text-gray-500">Liabilities</div><div className="text-lg font-semibold">{fmtUSD(liab?.val)}</div><div className="text-[10px] text-gray-400">{liab?.end || "‚Äî"}</div></div>
            <div className="p-3 rounded-2xl bg-gray-50"><div className="text-xs text-gray-500">Equity</div><div className="text-lg font-semibold">{fmtUSD(equity?.val)}</div><div className="text-[10px] text-gray-400">{equity?.end || "‚Äî"}</div></div>
          </div>
          <p className="text-xs text-gray-400 mt-2">Data source: <code>data.sec.gov</code> CompanyFacts API. Replace the <code>User-Agent</code> header with your email/firm per SEC guidance.</p>
        </CardContent>
      </Card>

      {/* Macro & Spreads (FRED) */}
      <Card className="col-span-3">
        <CardContent>
          <h2 className="text-xl font-bold mb-2">üåê Macro Strip ‚Äî UST & Credit Spreads (FRED)</h2>
          {!FRED_API_KEY || FRED_API_KEY === "YOUR_FRED_API_KEY" ? (
            <p className="text-xs text-yellow-700 mb-2">Add your FRED API key in code to enable live macro charts.</p>
          ) : null}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div className="text-sm font-semibold mb-2">US 2Y vs 10Y Treasury Yield</div>
              <ResponsiveContainer width="100%" height={180}>
                <LineChart data={fredSeries(fred.t2y)}>
                  <XAxis dataKey="date" hide />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip />
                  <Line type="monotone" dataKey="value" stroke="#2563eb" name="2Y" />
                </LineChart>
              </ResponsiveContainer>
              <ResponsiveContainer width="100%" height={180}>
                <LineChart data={fredSeries(fred.t10y)}>
                  <XAxis dataKey="date" hide />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip />
                  <Line type="monotone" dataKey="value" stroke="#16a34a" name="10Y" />
                </LineChart>
              </ResponsiveContainer>
            </div>
            <div>
              <div className="text-sm font-semibold mb-2">ICE BofA OAS ‚Äî HY vs IG</div>
              <ResponsiveContainer width="100%" height={180}>
                <LineChart data={fredSeries(fred.hy)}>
                  <XAxis dataKey="date" hide />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip />
                  <Line type="monotone" dataKey="value" stroke="#ef4444" name="HY OAS (bps)" />
                </LineChart>
              </ResponsiveContainer>
              <ResponsiveContainer width="100%" height={180}>
                <LineChart data={fredSeries(fred.ig)}>
                  <XAxis dataKey="date" hide />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip />
                  <Line type="monotone" dataKey="value" stroke="#f59e0b" name="IG OAS (bps)" />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Client Pipeline (kept) */}
      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-4">ü§ù Client Pipeline</h2>
          <ResponsiveContainer width="100%" height={200}>
            <BarChart data={pipelineData}>
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="deals" fill="#f97316" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Sector Heatmap (kept) */}
      <Card className="col-span-2">
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üî• Sector Heatmap</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
              { sector: "Tech", status: "Hot" },
              { sector: "Energy", status: "Warm" },
              { sector: "Healthcare", status: "Hot" },
              { sector: "Retail", status: "Cold" },
            ].map((s, i) => (
              <motion.div key={i} whileHover={{ scale: 1.05 }} className="p-4 rounded-2xl shadow bg-gray-50 text-center">
                <p className="font-semibold">{s.sector}</p>
                <p className={`text-sm ${s.status === "Hot" ? "text-red-600" : s.status === "Cold" ? "text-blue-600" : "text-yellow-600"}`}>{s.status}</p>
              </motion.div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Capital Structure Monitor (kept) */}
      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üè¶ Capital Structure Risk</h2>
          <ul className="space-y-2">
            <li>‚ö†Ô∏è Client A: Refi cliff in 2026</li>
            <li>‚ö†Ô∏è Client B: Net Leverage 6.2x</li>
            <li>‚úÖ Client C: IG Stable</li>
            <li>‚ö†Ô∏è Client D: Rating under review</li>
          </ul>
        </CardContent>
      </Card>

      {/* Team & Revenue Performance (kept) */}
      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üìà Team & Revenue</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="flex items-center space-x-2">
              <DollarSign className="text-green-600" />
              <span>$52m YTD Fees</span>
            </div>
            <div className="flex items-center space-x-2">
              <TrendingUp className="text-blue-600" />
              <span>12 Mandates Won</span>
            </div>
            <div className="flex items-center space-x-2">
              <Users className="text-purple-600" />
              <span>Team Utilization: 87%</span>
            </div>
            <div className="flex items-center space-x-2">
              <Briefcase className="text-orange-600" />
              <span>Fee Wallet: +8% vs peers</span>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* AI-Powered Alerts with Actions */}
      <Card className="col-span-3">
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üîî AI-Powered Alerts</h2>
          <ul className="space-y-3">
            {aiAlerts.map((a, i) => (
              <li key={i} className="flex items-start justify-between gap-3 p-3 rounded-xl bg-gray-50">
                <div className="flex items-start gap-2">
                  <Bell className="text-red-600 mt-0.5" />
                  <div>
                    <div className="font-semibold">{a.client}</div>
                    <div className="text-sm">{a.alert}</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button className="text-xs">Schedule CFO Call</Button>
                  <Button className="text-xs">Draft Client Note</Button>
                  <Button className="text-xs">Open Pitch Template</Button>
                </div>
              </li>
            ))}
          </ul>
        </CardContent>
      </Card>

      {/* Scenario Simulation (kept) */}
      <Card className="col-span-3">
        <CardContent>
          <h2 className="text-xl font-bold mb-4">üîÆ Scenario Simulator</h2>
          <p className="mb-4 text-sm">Adjust assumptions and see impact on clients‚Äô WACC, leverage, and coverage ratios in real time.</p>
          <Button className="mr-4">+100bps Rates</Button>
          <Button className="mr-4">+50bps Spreads</Button>
          <Button>-5% FX</Button>
        </CardContent>
      </Card>
    </div>
  );
}
